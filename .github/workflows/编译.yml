name: è‡ªåŠ¨æ„å»º OpenWRT å…¼å®¹é™æ€ ARM64 ç‰ˆæœ¬
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build_static_arm64:
    name: é™æ€æ‰“åŒ… Linux ARM64ï¼ˆOpenWRT å…¼å®¹ï¼‰
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… QEMUï¼ˆç”¨äºæ¨¡æ‹Ÿ ARM64ï¼‰
        run: |
          sudo apt update
          sudo apt install -y qemu-user-static

      - name: é€šè¿‡ Docker Alpine ARM64 æ‰§è¡Œé™æ€æ‰“åŒ…
        run: |
          # å¯åŠ¨ Alpine ARM64 å®¹å™¨ï¼ŒæŒ‚è½½å½“å‰ç›®å½•åˆ° /app
          docker run --rm -v ${{ github.workspace }}:/app -w /app --platform linux/arm64 alpine:3.18 sh -c "
            # å®‰è£…ä¾èµ–
            apk add --no-cache python3 py3-pip py3-pyinstaller build-base zlib-dev openssl-dev musl-dev
            # å®‰è£…é¡¹ç›®ä¾èµ–
            pip3 install -r requirements.txt
            # æ‰§è¡Œé™æ€æ‰“åŒ…
            python3 build_static.py
          "

      - name: æŸ¥çœ‹æ‰“åŒ…äº§ç‰©
        run: ls -l dist/

      - name: ä¸Šä¼ é™æ€äº§ç‰©åˆ° Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-linux-arm64-static
          path: dist/CloudflareSpeedTest-linux-arm64-static

      - name: ç”Ÿæˆ Releaseï¼ˆæ‰“æ ‡ç­¾æ—¶è‡ªåŠ¨å‘å¸ƒï¼‰
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: ç‰ˆæœ¬ ${{ github.ref_name }}ï¼ˆå« OpenWRT é™æ€ç‰ˆï¼‰
          tag_name: ${{ github.ref_name }}
          files: dist/CloudflareSpeedTest-linux-arm64-static
          body: |
            ## Cloudflare SpeedTest ${{ github.ref_name }} å‘å¸ƒ
            
            ### âœ… OpenWRT å…¼å®¹é™æ€ç‰ˆï¼ˆæ¨èï¼‰
            - [CloudflareSpeedTest-linux-arm64-static](https://github.com/ZCCtt/yx-tools/releases/download/${{ github.ref_name }}/CloudflareSpeedTest-linux-arm64-static)
            > ğŸ“Œ **ç‰¹ç‚¹**ï¼šé™æ€ç¼–è¯‘ï¼Œæ— éœ€å®‰è£…ä»»ä½•ä¾èµ–ï¼Œç›´æ¥åœ¨ OpenWRTï¼ˆmusl libcï¼‰ä¸Šè¿è¡Œï¼
            
            ### ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½é™æ€ç‰ˆæ–‡ä»¶
            2. ä¸Šä¼ åˆ° OpenWRTï¼ˆå¦‚ /tmp ç›®å½•ï¼‰
            3. èµ‹äºˆæƒé™ï¼š`chmod +x CloudflareSpeedTest-linux-arm64-static`
            4. ç›´æ¥è¿è¡Œï¼š`./CloudflareSpeedTest-linux-arm64-static`
