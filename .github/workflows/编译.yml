name: å¤šå¹³å°è‡ªåŠ¨æ‰“åŒ… + OpenWRT é™æ€ç‰ˆ

on:
  push:
    tags:
      - 'v*'  # æ‰“æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰æ—¶è§¦å‘æ„å»ºå’Œå‘å¸ƒ
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# ------------------------------
# å…¨å±€å¹¶å‘æ§åˆ¶ï¼ˆå…³é”®ï¼šå¼€å¯å¹¶è¡Œæ„å»ºï¼‰
# ------------------------------
concurrency:
  group: ${{ github.ref }}  # æŒ‰åˆ†æ”¯/æ ‡ç­¾åˆ†ç»„ï¼ŒåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªè¿è¡Œå®ä¾‹
  cancel-in-progress: true  # å–æ¶ˆæ­£åœ¨è¿è¡Œçš„æ—§ä»»åŠ¡ï¼ˆé¿å…èµ„æºæµªè´¹ï¼‰

jobs:
  # ------------------------------
  # 1. æ„å»º Linux amd64ï¼ˆåŠ¨æ€é“¾æ¥ï¼‰
  # ------------------------------
  build_linux_amd64:
    name: Linux amd64
    runs-on: ubuntu-latest
    # å•ä¸ªä»»åŠ¡å¹¶å‘é…ç½®
    concurrency:
      group: build-linux-amd64-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–ä¸æ‰“åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          python build.py  # æ™®é€šæ‰“åŒ…ï¼ˆè‡ªåŠ¨è¯†åˆ«å¹³å°ï¼‰

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-linux-amd64
          path: dist/CloudflareSpeedTest-linux-amd64

  # ------------------------------
  # 2. æ„å»º Linux arm64ï¼ˆåŠ¨æ€é“¾æ¥ï¼ŒUbuntu glibcï¼‰
  # ------------------------------
  build_linux_arm64:
    name: Linux arm64 (glibc)
    runs-on: ubuntu-latest
    # å•ä¸ªä»»åŠ¡å¹¶å‘é…ç½®
    concurrency:
      group: build-linux-arm64-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… QEMUï¼ˆæ¨¡æ‹Ÿ ARM64ï¼‰
        run: |
          sudo apt update
          sudo apt install -y qemu-user-static

      - name: åœ¨ ARM64 å®¹å™¨ä¸­æ‰“åŒ…
        run: |
          docker run --rm -v ${{ github.workspace }}:/app -w /app --platform linux/arm64 ubuntu:22.04 bash -c "
            apt update && apt install -y python3 python3-pip python3-venv libpython3.10
            python3 -m pip install --upgrade pip
            pip3 install pyinstaller
            pip3 install -r requirements.txt
            python3 build.py
          "

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-linux-arm64
          path: dist/CloudflareSpeedTest-linux-arm64

  # ------------------------------
  # 3. æ„å»º OpenWRT å…¼å®¹é™æ€ ARM64ï¼ˆmusl libcï¼‰
  # ------------------------------
  build_openwrt_static_arm64:
    name: OpenWRT Static ARM64
    runs-on: ubuntu-latest
    # å•ä¸ªä»»åŠ¡å¹¶å‘é…ç½®
    concurrency:
      group: build-openwrt-static-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… QEMUï¼ˆæ¨¡æ‹Ÿ ARM64ï¼‰
        run: |
          sudo apt update
          sudo apt install -y qemu-user-static

      - name: åœ¨ Alpine ARM64 å®¹å™¨ä¸­é™æ€æ‰“åŒ…
        run: |
          docker run --rm -v ${{ github.workspace }}:/app -w /app --platform linux/arm64 alpine:3.18 sh -c "
            apk add --no-cache python3 py3-pip build-base zlib-dev openssl-dev musl-dev
            pip3 install --upgrade pip
            pip3 install pyinstaller
            pip3 install -r requirements.txt
            python3 build.py --static
          "

      - name: ä¸Šä¼ é™æ€äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-linux-arm64-static
          path: dist/CloudflareSpeedTest-linux-arm64-static

  # ------------------------------
  # 4. æ„å»º macOS amd64ï¼ˆä¼˜åŒ– runnerï¼Œå‡å°‘é˜Ÿåˆ—æ‹¥å µï¼‰
  # ------------------------------
  build_macos_amd64:
    name: macOS amd64
    runs-on: macos-13  # ç”¨ macos-13 æ›¿ä»£ macos-12ï¼Œé˜Ÿåˆ—æ›´çŸ­
    # å•ä¸ªä»»åŠ¡å¹¶å‘é…ç½®
    concurrency:
      group: build-macos-amd64-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: è®¾ç½® Pythonï¼ˆæ˜ç¡®æŒ‡å®š x64 æ¶æ„ï¼‰
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: 'x64'  # ç¡®ä¿æ˜¯ Intel æ¶æ„äº§ç‰©

      - name: å®‰è£…ä¾èµ–ä¸æ‰“åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          python build.py

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-macos-amd64
          path: dist/CloudflareSpeedTest-macos-amd64

  # ------------------------------
  # 5. æ„å»º macOS arm64ï¼ˆApple Siliconï¼‰
  # ------------------------------
  build_macos_arm64:
    name: macOS arm64
    runs-on: macos-14  # Apple Silicon ä¸“ç”¨ runner
    # å•ä¸ªä»»åŠ¡å¹¶å‘é…ç½®
    concurrency:
      group: build-macos-arm64-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: è®¾ç½® Pythonï¼ˆarm64 æ¶æ„ï¼‰
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: 'arm64'

      - name: å®‰è£…ä¾èµ–ä¸æ‰“åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          python build.py

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-macos-arm64
          path: dist/CloudflareSpeedTest-macos-arm64

  # ------------------------------
  # 6. æ„å»º Windows amd64
  # ------------------------------
  build_windows_amd64:
    name: Windows amd64
    runs-on: windows-latest
    # å•ä¸ªä»»åŠ¡å¹¶å‘é…ç½®
    concurrency:
      group: build-windows-amd64-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–ä¸æ‰“åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          python build.py

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-windows-amd64
          path: dist/CloudflareSpeedTest-windows-amd64.exe

  # ------------------------------
  # 7. è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releasesï¼ˆä¾èµ–æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼‰
  # ------------------------------
  release:
    name: Create GitHub Release
    needs: [build_linux_amd64, build_linux_arm64, build_openwrt_static_arm64, build_macos_amd64, build_macos_arm64, build_windows_amd64]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    # å‘å¸ƒä»»åŠ¡å¹¶å‘é…ç½®
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ‰“åŒ…äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./release_assets

      - name: æŸ¥çœ‹äº§ç‰©åˆ—è¡¨
        run: |
          echo "Release assets:"
          find ./release_assets -type f

      - name: ç”Ÿæˆ Release è¯´æ˜
        run: |
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "## Cloudflare SpeedTest ${{ github.ref_name }} å‘å¸ƒ" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "### ğŸ“¦ ä¸‹è½½é“¾æ¥" >> $GITHUB_ENV
          echo "- [Linux amd64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/CloudflareSpeedTest-linux-amd64)" >> $GITHUB_ENV
          echo "- [Linux arm64 (glibc)](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/CloudflareSpeedTest-linux-arm64)" >> $GITHUB_ENV
          echo "- [**OpenWRT é™æ€ ARM64**](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/CloudflareSpeedTest-linux-arm64-static) âœ…" >> $GITHUB_ENV
          echo "- [macOS amd64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/CloudflareSpeedTest-macos-amd64)" >> $GITHUB_ENV
          echo "- [macOS arm64 (Apple Silicon)](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/CloudflareSpeedTest-macos-arm64)" >> $GITHUB_ENV
          echo "- [Windows amd64](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/CloudflareSpeedTest-windows-amd64.exe)" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "### ğŸ“Œ ä½¿ç”¨è¯´æ˜" >> $GITHUB_ENV
          echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶" >> $GITHUB_ENV
          echo "2. Linux/macOS: èµ‹äºˆæ‰§è¡Œæƒé™ \`chmod +x æ–‡ä»¶å\`" >> $GITHUB_ENV
          echo "3. ç›´æ¥è¿è¡Œå³å¯" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ç‰ˆæœ¬ ${{ github.ref_name }}
          body: ${{ env.RELEASE_NOTES }}
          files: |
            ./release_assets/CloudflareSpeedTest-linux-amd64/CloudflareSpeedTest-linux-amd64
            ./release_assets/CloudflareSpeedTest-linux-arm64/CloudflareSpeedTest-linux-arm64
            ./release_assets/CloudflareSpeedTest-linux-arm64-static/CloudflareSpeedTest-linux-arm64-static
            ./release_assets/CloudflareSpeedTest-macos-amd64/CloudflareSpeedTest-macos-amd64
            ./release_assets/CloudflareSpeedTest-macos-arm64/CloudflareSpeedTest-macos-arm64
            ./release_assets/CloudflareSpeedTest-windows-amd64/CloudflareSpeedTest-windows-amd64.exe
          draft: false
          prerelease: false
