name: 多平台自动打包与发布
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: 构建 ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-13, macos-14]
        arch: [amd64, arm64]
        exclude:
          - os: windows-latest
            arch: arm64
        include:
          - os: ubuntu-latest
            arch: arm64
            docker_image: arm64v8/ubuntu:22.04

    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python（非 ARM64 平台）
        if: matrix.arch != 'arm64'
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: 安装依赖与打包工具（非 ARM64 平台）
        if: matrix.arch != 'arm64'
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: 执行本地打包脚本（非 ARM64 平台）
        if: matrix.arch != 'arm64'
        run: python build.py

      - name: 构建 Linux ARM64 版本（安装 Python 共享库）
        if: matrix.os == 'ubuntu-latest' && matrix.arch == 'arm64'
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 25
          max_attempts: 2
          command: |
            docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
            docker run --rm -v ${{ github.workspace }}:/app -w /app --platform linux/arm64 ${{ matrix.docker_image }} bash -c "
              # 替换国内 ARM64 镜像源
              cp /etc/apt/sources.list /etc/apt/sources.list.bak
              echo 'deb http://mirrors.aliyun.com/ubuntu-ports/ jammy main restricted universe multiverse' > /etc/apt/sources.list
              echo 'deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-updates main restricted universe multiverse' >> /etc/apt/sources.list
              echo 'deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-backports main restricted universe multiverse' >> /etc/apt/sources.list
              echo 'deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-security main restricted universe multiverse' >> /etc/apt/sources.list
              
              # 关键修复：安装 Python 3.10 共享库（libpython3.10）
              apt update --fix-missing
              apt install -y --no-install-recommends python3 python3-pip python3-venv build-essential zlib1g-dev libssl-dev libffi-dev libpython3.10
              
              # 升级 pip 并创建虚拟环境
              python3 -m pip install --upgrade pip
              python3 -m venv build_env && source build_env/bin/activate
              
              # 安装打包依赖
              pip install --no-cache-dir -r requirements.txt pyinstaller certifi urllib3
              
              # 执行打包命令
              python3 -m PyInstaller --onefile --name CloudflareSpeedTest-linux-arm64 --clean --console --hidden-import requests --hidden-import urllib3 --hidden-import certifi --hidden-import charset_normalizer --hidden-import idna --exclude-module tkinter --exclude-module matplotlib --exclude-module numpy --exclude-module pandas --exclude-module PIL --exclude-module cv2 --exclude-module scipy --strip --optimize 2 /app/cloudflare_speedtest.py
              
              deactivate
              chmod +x dist/CloudflareSpeedTest-linux-arm64
            "

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 下载所有产物（合并到 dist 目录）
        uses: actions/download-artifact@v4
        with:
          path: ./dist
          merge-multiple: true

      - name: 查看下载的文件（调试）
        run: ls -l ./dist

      - name: 生成版本号
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
          else
            echo "VERSION=nightly-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
          fi

      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          name: 版本 ${{ env.VERSION }}
          tag_name: ${{ env.VERSION }}
          files: ./dist/*
          generate_release_notes: true
          body: |
            ## Cloudflare SpeedTest ${{ env.VERSION }} 发布
            
            ### 下载链接
            - Windows amd64: [CloudflareSpeedTest-windows-amd64.exe](https://github.com/ZCCtt/yx-tools/releases/download/${{ env.VERSION }}/CloudflareSpeedTest-windows-amd64.exe)
            - Linux amd64: [CloudflareSpeedTest-linux-amd64](https://github.com/ZCCtt/yx-tools/releases/download/${{ env.VERSION }}/CloudflareSpeedTest-linux-amd64)
            - Linux arm64: [CloudflareSpeedTest-linux-arm64](https://github.com/ZCCtt/yx-tools/releases/download/${{ env.VERSION }}/CloudflareSpeedTest-linux-arm64)
            - macOS amd64: [CloudflareSpeedTest-macos-amd64](https://github.com/ZCCtt/yx-tools/releases/download/${{ env.VERSION }}/CloudflareSpeedTest-macos-amd64)
            - macOS arm64: [CloudflareSpeedTest-macos-arm64](https://github.com/ZCCtt/yx-tools/releases/download/${{ env.VERSION }}/CloudflareSpeedTest-macos-arm64)
            
            ### 使用说明
            1. 下载对应平台的可执行文件
            2. 赋予执行权限（Linux/macOS）：`chmod +x 文件名`
            3. 直接运行：`./文件名`
