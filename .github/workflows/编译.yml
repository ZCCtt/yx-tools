name: å¤šå¹³å°è‡ªåŠ¨æ‰“åŒ… + OpenWRT é™æ€ç‰ˆ

on:
  push:
    tags:
      - 'v*'  # ä»…åŒ¹é… v1.0.0ã€v2.1.5 ç­‰æ ‡ç­¾
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘æ—¶ä¹Ÿæ‰§è¡Œï¼ˆæ–°å¢ï¼šæ”¯æŒæ‰‹åŠ¨å‘å¸ƒï¼‰
    inputs:
      release_version:  # æ‰‹åŠ¨è§¦å‘æ—¶éœ€è¾“å…¥ç‰ˆæœ¬å·ï¼ˆå¦‚ v1.0.0ï¼‰
        description: 'è¯·è¾“å…¥ Release ç‰ˆæœ¬å·ï¼ˆæ ¼å¼ï¼švX.Y.Zï¼‰'
        required: true
        default: 'v1.0.0'

# å…¨å±€å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. Linux amd64 æ‰“åŒ…ï¼ˆä¸å˜ï¼‰
  build_linux_amd64:
    name: Linux amd64
    runs-on: ubuntu-latest
    concurrency:
      group: build-linux-amd64-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: å®‰è£…ä¾èµ–ä¸æ‰“åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          python build.py
      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-linux-amd64
          path: dist/CloudflareSpeedTest-linux-amd64

  # 2. Linux arm64 (glibc) æ‰“åŒ…ï¼ˆå·²ä¿®å¤æºé—®é¢˜ï¼‰
  build_linux_arm64:
    name: Linux arm64 (glibc)
    runs-on: ubuntu-latest
    concurrency:
      group: build-linux-arm64-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: å®‰è£… QEMU
        run: |
          sudo apt update
          sudo apt install -y qemu-user-static
      - name: åœ¨ ARM64 å®¹å™¨ä¸­æ‰“åŒ…
        run: |
          docker run --rm -v ${{ github.workspace }}:/app -w /app --platform linux/arm64 ubuntu:22.04 bash -c "
            # æ›´æ¢é˜¿é‡Œäº‘ ARM64 æº
            cat > /etc/apt/sources.list << EOF
            deb http://mirrors.aliyun.com/ubuntu-ports/ jammy main restricted universe multiverse
            deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-updates main restricted universe multiverse
            deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-security main restricted universe multiverse
            EOF
            # apt update é‡è¯•æœºåˆ¶
            for i in {1..3}; do
              apt update && break
              echo 'ç¬¬ $i æ¬¡æ›´æ–°å¤±è´¥ï¼Œ10ç§’åé‡è¯•...'
              sleep 10
            done
            # å®‰è£…å¹¶éªŒè¯ Python
            apt install -y python3 python3-pip python3-venv libpython3.10
            if ! command -v python3 &> /dev/null; then exit 1; fi
            if ! command -v pip3 &> /dev/null; then exit 1; fi
            # æ‰“åŒ…æ­¥éª¤
            python3 -m pip install --upgrade pip
            pip3 install pyinstaller
            pip3 install -r requirements.txt
            python3 build.py
          "
      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-linux-arm64
          path: dist/CloudflareSpeedTest-linux-arm64

  # 3. OpenWRT é™æ€ ARM64 æ‰“åŒ…ï¼ˆä¸å˜ï¼‰
  build_openwrt_static_arm64:
    name: OpenWRT Static ARM64
    runs-on: ubuntu-latest
    concurrency:
      group: build-openwrt-static-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: å®‰è£… QEMU
        run: |
          sudo apt update
          sudo apt install -y qemu-user-static
      - name: åœ¨ Alpine ARM64 å®¹å™¨ä¸­é™æ€æ‰“åŒ…
        run: |
          docker run --rm -v ${{ github.workspace }}:/app -w /app --platform linux/arm64 alpine:3.18 sh -c "
            apk add --no-cache python3 py3-pip build-base zlib-dev openssl-dev musl-dev
            pip3 install --upgrade pip
            pip3 install pyinstaller
            pip3 install -r requirements.txt
            python3 build.py --static
          "
      - name: ä¸Šä¼ é™æ€äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-linux-arm64-static
          path: dist/CloudflareSpeedTest-linux-arm64-static

  # 4. macOS amd64 æ‰“åŒ…ï¼ˆä¸å˜ï¼‰
  build_macos_amd64:
    name: macOS amd64
    runs-on: macos-13
    concurrency:
      group: build-macos-amd64-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: è®¾ç½® Pythonï¼ˆx64ï¼‰
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: 'x64'
      - name: å®‰è£…ä¾èµ–ä¸æ‰“åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          python build.py
      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-macos-amd64
          path: dist/CloudflareSpeedTest-macos-amd64

  # 5. macOS arm64 æ‰“åŒ…ï¼ˆä¸å˜ï¼‰
  build_macos_arm64:
    name: macOS arm64
    runs-on: macos-14
    concurrency:
      group: build-macos-arm64-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: è®¾ç½® Pythonï¼ˆarm64ï¼‰
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: 'arm64'
      - name: å®‰è£…ä¾èµ–ä¸æ‰“åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          python build.py
      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-macos-arm64
          path: dist/CloudflareSpeedTest-macos-arm64

  # 6. Windows amd64 æ‰“åŒ…ï¼ˆä¸å˜ï¼‰
  build_windows_amd64:
    name: Windows amd64
    runs-on: windows-latest
    concurrency:
      group: build-windows-amd64-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      - name: å®‰è£…ä¾èµ–ä¸æ‰“åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
          python build.py
      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: CloudflareSpeedTest-windows-amd64
          path: dist/CloudflareSpeedTest-windows-amd64.exe

  # ------------------------------
  # ä¿®å¤ï¼šRelease ä»»åŠ¡ï¼ˆæ”¯æŒæ ‡ç­¾è§¦å‘ + æ‰‹åŠ¨è§¦å‘ï¼‰
  # ------------------------------
  release:
    name: Create GitHub Release
    needs: [build_linux_amd64, build_linux_arm64, build_openwrt_static_arm64, build_macos_amd64, build_macos_arm64, build_windows_amd64]
    runs-on: ubuntu-latest
    # å…³é”®ä¿®å¤1ï¼šæ”¯æŒä¸¤ç§è§¦å‘æ–¹å¼ï¼ˆæ ‡ç­¾æ¨é€ + æ‰‹åŠ¨è§¦å‘ï¼‰
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ‰“åŒ…äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./release_assets

      - name: æŸ¥çœ‹äº§ç‰©åˆ—è¡¨ï¼ˆè°ƒè¯•ç”¨ï¼‰
        run: |
          echo "äº§ç‰©ç›®å½•ç»“æ„ï¼š"
          find ./release_assets -type f

      - name: ç¡®å®š Release ç‰ˆæœ¬å·ï¼ˆå…³é”®ä¿®å¤2ï¼‰
        run: |
          # æ ‡ç­¾è§¦å‘æ—¶ï¼Œç”¨æ ‡ç­¾ä½œä¸ºç‰ˆæœ¬å·ï¼ˆå¦‚ v1.0.0ï¼‰
          if [ "${{ github.event_name }}" = "push" ]; then
            RELEASE_VERSION=${{ github.ref_name }}
          # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œç”¨è¾“å…¥çš„ç‰ˆæœ¬å·
          else
            RELEASE_VERSION=${{ github.event.inputs.release_version }}
          fi
          echo "å½“å‰ Release ç‰ˆæœ¬å·ï¼š$RELEASE_VERSION"
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_ENV

      - name: ç”Ÿæˆ Release è¯´æ˜
        run: |
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "## Cloudflare SpeedTest ${{ env.RELEASE_VERSION }} å‘å¸ƒ" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "### ğŸ“¦ ä¸‹è½½é“¾æ¥" >> $GITHUB_ENV
          echo "- [Linux amd64](https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_VERSION }}/CloudflareSpeedTest-linux-amd64)" >> $GITHUB_ENV
          echo "- [Linux arm64 (glibc)](https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_VERSION }}/CloudflareSpeedTest-linux-arm64)" >> $GITHUB_ENV
          echo "- [**OpenWRT é™æ€ ARM64**](https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_VERSION }}/CloudflareSpeedTest-linux-arm64-static) âœ…" >> $GITHUB_ENV
          echo "- [macOS amd64](https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_VERSION }}/CloudflareSpeedTest-macos-amd64)" >> $GITHUB_ENV
          echo "- [macOS arm64 (Apple Silicon)](https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_VERSION }}/CloudflareSpeedTest-macos-arm64)" >> $GITHUB_ENV
          echo "- [Windows amd64](https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_VERSION }}/CloudflareSpeedTest-windows-amd64.exe)" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "### ğŸ“Œ ä½¿ç”¨è¯´æ˜" >> $GITHUB_ENV
          echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶" >> $GITHUB_ENV
          echo "2. Linux/macOS: èµ‹äºˆæ‰§è¡Œæƒé™ \`chmod +x æ–‡ä»¶å\`" >> $GITHUB_ENV
          echo "3. ç›´æ¥è¿è¡Œå³å¯" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: åˆ›å»º GitHub Releaseï¼ˆå…³é”®ä¿®å¤3ï¼‰
        uses: softprops/action-gh-release@v1
        with:
          # ç”¨ç¡®å®šå¥½çš„ç‰ˆæœ¬å·ä½œä¸ºæ ‡ç­¾å’Œåç§°
          tag_name: ${{ env.RELEASE_VERSION }}
          name: ç‰ˆæœ¬ ${{ env.RELEASE_VERSION }}
          body: ${{ env.RELEASE_NOTES }}
          # ç¡®ä¿äº§ç‰©è·¯å¾„æ­£ç¡®ï¼ˆå…³é”®ï¼šé¿å…å› è·¯å¾„é”™è¯¯å¯¼è‡´æ— äº§ç‰©ï¼‰
          files: |
            ./release_assets/CloudflareSpeedTest-linux-amd64/CloudflareSpeedTest-linux-amd64
            ./release_assets/CloudflareSpeedTest-linux-arm64/CloudflareSpeedTest-linux-arm64
            ./release_assets/CloudflareSpeedTest-linux-arm64-static/CloudflareSpeedTest-linux-arm64-static
            ./release_assets/CloudflareSpeedTest-macos-amd64/CloudflareSpeedTest-macos-amd64
            ./release_assets/CloudflareSpeedTest-macos-arm64/CloudflareSpeedTest-macos-arm64
            ./release_assets/CloudflareSpeedTest-windows-amd64/CloudflareSpeedTest-windows-amd64.exe
          draft: false
          prerelease: false
